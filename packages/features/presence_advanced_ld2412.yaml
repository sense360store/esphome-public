---
# ============================================================================
# PRESENCE DETECTION - ADVANCED PROFILE (LD2412)
# ============================================================================
# Advanced presence detection for LD2412 mmWave sensor.
# Includes gate-based threshold configuration, engineering mode,
# calibration controls, and detailed energy/distance sensors.
#
# LD2412-specific features:
# - 14 detection gates (0-13) at configurable resolution
# - Distance resolution: 0.75m, 0.5m, or 0.2m
# - Engineering mode for detailed diagnostics
# - Dynamic background correction for auto-calibration
# - Superior still presence detection up to 9 meters
# ============================================================================

# Include basic profile as foundation
packages:
  presence_base: !include presence_basic.yaml

# ----------------------------------------------------------------------------
# DISTANCE CONTROLS
# ----------------------------------------------------------------------------
# NOTE: Advanced gate configuration (number.ld2412 platform) is not supported
# by the current ld2412 external component. Gate thresholds must be configured
# via the radar's built-in app or serial commands.
# ----------------------------------------------------------------------------

sensor:
  # ----------------------------------------------------------------------------
  # DISTANCE & ENERGY SENSORS (User-facing) - Native ESPHome Copy Sensors
  # ----------------------------------------------------------------------------
  # Moving distance - Native copy from hardware sensor
  - platform: copy
    id: ld2412_moving_distance_exposed
    source_id: ld2412_moving_distance
    name: "${friendly_name} Moving Distance"
    icon: "mdi:ruler"
    unit_of_measurement: "cm"
    accuracy_decimals: 0
    state_class: measurement

  # Still distance - Native copy from hardware sensor
  - platform: copy
    id: ld2412_still_distance_exposed
    source_id: ld2412_still_distance
    name: "${friendly_name} Still Distance"
    icon: "mdi:ruler"
    unit_of_measurement: "cm"
    accuracy_decimals: 0
    state_class: measurement

  # Moving energy - Native copy from hardware sensor
  - platform: copy
    id: ld2412_moving_energy_exposed
    source_id: ld2412_moving_energy
    name: "${friendly_name} Moving Energy"
    icon: "mdi:signal-variant"
    unit_of_measurement: "%"
    accuracy_decimals: 0
    state_class: measurement

  # Still energy - Native copy from hardware sensor
  - platform: copy
    id: ld2412_still_energy_exposed
    source_id: ld2412_still_energy
    name: "${friendly_name} Still Energy"
    icon: "mdi:signal"
    unit_of_measurement: "%"
    accuracy_decimals: 0
    state_class: measurement

  # Detection confidence level (0-100%) - Keep template for calculation
  - platform: template
    id: detection_confidence_level
    name: "${friendly_name} Detection Confidence"
    icon: "mdi:progress-check"
    unit_of_measurement: "%"
    accuracy_decimals: 1
    state_class: measurement
    update_interval: 1s
    lambda: |-
      return id(presence_confidence) * 100.0f;

# ----------------------------------------------------------------------------
# CONFIGURATION SELECTORS
# ----------------------------------------------------------------------------
# NOTE: ld2412 select/switch/button platforms are not supported by the current
# external component. Use the radar's built-in app for configuration.
# ----------------------------------------------------------------------------
select:
  # Sensitivity modes (template-controlled)
  - platform: template
    id: presence_sensitivity
    name: "${friendly_name} Presence Sensitivity"
    icon: "mdi:tune"
    optimistic: true
    options:
      - Quiet Room      # Low threshold - detects subtle movements
      - Normal          # Balanced for typical rooms
      - High Traffic    # High threshold - ignores minor movements
    initial_option: Normal
    restore_value: true
    on_value:
      then:
        - lambda: |-
            // Log sensitivity change
            if (x == "Quiet Room") {
              ESP_LOGI("presence", "Sensitivity: Quiet Room (high sensitivity)");
            } else if (x == "Normal") {
              ESP_LOGI("presence", "Sensitivity: Normal");
            } else if (x == "High Traffic") {
              ESP_LOGI("presence", "Sensitivity: High Traffic (low sensitivity)");
            }

# ----------------------------------------------------------------------------
# CONTROL BUTTONS
# ----------------------------------------------------------------------------
button:
  # Reset presence confidence
  - platform: template
    name: "${friendly_name} Reset Presence Calibration"
    icon: "mdi:restart"
    on_press:
      - lambda: |-
          id(presence_confidence) = 0.0f;
          ESP_LOGI("presence", "Presence calibration reset");

# ----------------------------------------------------------------------------
# DIAGNOSTICS
# ----------------------------------------------------------------------------
text_sensor:
  # Diagnostics
  - platform: template
    id: presence_diagnostics
    name: "${friendly_name} Presence Diagnostics"
    icon: "mdi:information-outline"
    internal: true
    update_interval: 5s
    lambda: |-
      char buffer[256];
      snprintf(buffer, sizeof(buffer),
        "Confidence: %.1f%%, Moving: %s, Still: %s",
        id(presence_confidence) * 100.0f,
        id(ld2412_has_moving).state ? "Yes" : "No",
        id(ld2412_has_still).state ? "Yes" : "No"
      );
      return {buffer};

# ----------------------------------------------------------------------------
# BINARY SENSORS (User-facing) - Native ESPHome Copy Sensors
# ----------------------------------------------------------------------------
binary_sensor:
  # Expose moving target detection - Native copy from hardware sensor
  - platform: copy
    id: ld2412_moving_detected
    source_id: ld2412_has_moving
    name: "${friendly_name} Moving Detected"
    icon: "mdi:run"
    device_class: motion

  # Expose still target detection - Native copy from hardware sensor
  - platform: copy
    id: ld2412_still_detected
    source_id: ld2412_has_still
    name: "${friendly_name} Still Detected"
    icon: "mdi:human-handsdown"
    device_class: occupancy
