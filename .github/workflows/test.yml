name: Test ESPHome Configs

on:
  push:
    branches: ["*"]
  pull_request:
    branches: ["*"]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode: quick (representative), full (all combinations)'
        required: true
        default: 'quick'
        type: choice
        options:
          - quick
          - full

jobs:
  validate-yaml:
    name: Validate YAML Syntax
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pyyaml yamllint

      - name: Validate YAML syntax with validation script
        run: |
          python3 tests/validate_configs.py

      - name: Run yamllint
        run: |
          yamllint -d "{extends: default, rules: {line-length: {max: 120}, comments: {min-spaces-from-content: 1}}}" \
            products/ packages/ || true

  # ============================================================================
  # COMPREHENSIVE ESPHOME CONFIG TESTING
  # ============================================================================
  # Tests all valid module combinations according to the Sense360 ruleset:
  #
  # CORE types: CORE-C, CORE-V-C (ceiling), CORE-W, CORE-V-W (wall)
  # POWER types: USB, POE, PWR (240V)
  # LIGHTING: Voice cores require LED+MIC, non-voice LED is optional
  #
  # MODULE RULES:
  # - Ceiling: AirIQ-C, Bathroom-C (mutually exclusive), Comfort-C, Presence-C, Fan
  # - Wall: AirIQ-W, Comfort-W, Presence-W, Fan (no Bathroom)
  #
  # Constraints:
  # - AirIQ and Bathroom cannot be used together on ceiling
  # - Wall has no Bathroom option
  # ============================================================================

  generate-test-matrix:
    name: Generate Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.generate.outputs.matrix }}
      config_count: ${{ steps.generate.outputs.config_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate test matrix
        id: generate
        run: |
          # Determine test mode
          TEST_MODE="${{ github.event.inputs.test_mode || 'quick' }}"

          if [ "$TEST_MODE" = "full" ]; then
            echo "Running FULL test matrix (all combinations)"
            MATRIX=$(python3 tests/generate_test_configs.py --mode matrix --full)
            COUNT=$(python3 tests/generate_test_configs.py --mode list --full --json | jq '.total')
          else
            echo "Running QUICK test matrix (representative subset)"
            MATRIX=$(python3 tests/generate_test_configs.py --mode matrix --representative)
            COUNT=$(python3 tests/generate_test_configs.py --mode list --representative --json | jq '.total')
          fi

          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "config_count=$COUNT" >> $GITHUB_OUTPUT
          echo "Generated $COUNT test configurations"

  test-generated-configs:
    name: "Test: ${{ matrix.name }}"
    needs: generate-test-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.generate-test-matrix.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache ESPHome
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-platformio-

      - name: Install ESPHome
        run: |
          pip install esphome

      - name: Create secrets.yaml for testing
        run: |
          cat > secrets.yaml << 'EOF'
          wifi_ssid: "TestNetwork"
          wifi_password: "TestPassword123"
          api_encryption_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa="
          ota_password: "test-ota-password"
          fallback_ap_password: "fallback123"
          web_username: "admin"
          web_password: "test_web_password"
          EOF
          # Copy secrets to directories that need them
          cp secrets.yaml products/secrets.yaml
          cp secrets.yaml tests/secrets.yaml
          mkdir -p tests/generated
          cp secrets.yaml tests/generated/secrets.yaml

      - name: Generate test config
        run: |
          mkdir -p tests/generated
          # Determine test mode to match matrix generation
          TEST_MODE="${{ github.event.inputs.test_mode || 'quick' }}"
          if [ "$TEST_MODE" = "full" ]; then
            python3 tests/generate_test_configs.py --mode generate --full --output-dir tests/generated
          else
            python3 tests/generate_test_configs.py --mode generate --representative --output-dir tests/generated
          fi

      - name: Validate ESPHome config - ${{ matrix.name }}
        run: |
          CONFIG_FILE="tests/generated/test-${{ matrix.name }}.yaml"
          echo "Validating: $CONFIG_FILE"

          if [ -f "$CONFIG_FILE" ]; then
            esphome config "$CONFIG_FILE"
          else
            echo "Config file not found: $CONFIG_FILE"
            echo "Available configs:"
            ls -la tests/generated/
            exit 1
          fi

  # ============================================================================
  # EXISTING PRODUCT CONFIGS TEST
  # ============================================================================
  # Also test the existing hand-crafted product configurations
  test-existing-products:
    name: Test Existing Products
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          # Sense360 Core products (primary)
          - products/sense360-core-ceiling.yaml
          - products/sense360-core-ceiling-presence.yaml
          - products/sense360-core-ceiling-bathroom.yaml
          - products/sense360-core-wall.yaml
          - products/sense360-core-wall-presence.yaml
          - products/sense360-core-voice-ceiling.yaml
          - products/sense360-core-voice-wall.yaml
          # Sense360 Mini products (legacy)
          - products/sense360-mini-airiq.yaml
          - products/sense360-mini-airiq-basic.yaml
          - products/sense360-mini-airiq-advanced.yaml
          - products/sense360-mini-airiq-ld2412.yaml
          - products/sense360-mini-presence.yaml
          - products/sense360-mini-presence-basic.yaml
          - products/sense360-mini-presence-advanced.yaml
          - products/sense360-mini-presence-ld2412.yaml
          - products/sense360-mini-presence-advanced-ld2412.yaml
          # Sense360 Ceiling S3 products
          - products/sense360-ceiling-s3-full.yaml
          # Sense360 Power and Fan products
          - products/sense360-poe.yaml
          - products/sense360-fan-pwm.yaml
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache ESPHome
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: ${{ runner.os }}-platformio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-platformio-

      - name: Install ESPHome
        run: |
          pip install esphome

      - name: Create secrets.yaml for testing
        run: |
          cat > secrets.yaml << 'EOF'
          wifi_ssid: "TestNetwork"
          wifi_password: "TestPassword123"
          api_encryption_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa="
          ota_password: "test-ota-password"
          fallback_ap_password: "fallback123"
          web_username: "admin"
          web_password: "test_web_password"
          EOF
          cp secrets.yaml products/secrets.yaml

      - name: Validate ESPHome config
        run: |
          echo "Validating: ${{ matrix.config }}"
          esphome config ${{ matrix.config }}

  test-unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ESPHome
        run: |
          pip install esphome

      - name: Create secrets.yaml for testing
        run: |
          cat > secrets.yaml << 'EOF'
          wifi_ssid: "TestNetwork"
          wifi_password: "TestPassword123"
          api_encryption_key: "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa="
          ota_password: "test-ota-password"
          fallback_ap_password: "fallback123"
          web_username: "admin"
          web_password: "test_web_password"
          EOF
          cp secrets.yaml products/secrets.yaml
          cp secrets.yaml tests/secrets.yaml

      - name: Validate test configs
        run: |
          echo "Validating test configurations..."
          for file in tests/esphome/*.yaml; do
            if [ -f "$file" ]; then
              echo "Testing: $file"
              esphome config "$file" || echo "Warning: $file validation failed"
            fi
          done

  lint-cpp:
    name: Lint C++ Headers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Check C++ formatting
        run: |
          echo "Checking C++ header formatting..."
          find include/ -name "*.h" -o -name "*.cpp" | while read file; do
            echo "Checking: $file"
            clang-format --dry-run --Werror "$file" || echo "Warning: $file needs formatting"
          done

  # ============================================================================
  # TEST SUMMARY
  # ============================================================================
  test-summary:
    name: Test Summary
    needs: [validate-yaml, generate-test-matrix, test-generated-configs, test-existing-products, test-unit-tests, lint-cpp]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "=============================================="
          echo "TEST SUMMARY"
          echo "=============================================="
          echo ""
          echo "Test Matrix Size: ${{ needs.generate-test-matrix.outputs.config_count }} configurations"
          echo ""
          echo "Job Results:"
          echo "  - YAML Validation: ${{ needs.validate-yaml.result }}"
          echo "  - Matrix Generation: ${{ needs.generate-test-matrix.result }}"
          echo "  - Generated Config Tests: ${{ needs.test-generated-configs.result }}"
          echo "  - Existing Products: ${{ needs.test-existing-products.result }}"
          echo "  - Unit Tests: ${{ needs.test-unit-tests.result }}"
          echo "  - C++ Linting: ${{ needs.lint-cpp.result }}"
          echo ""

          # Fail if any required job failed
          if [ "${{ needs.validate-yaml.result }}" = "failure" ] || \
             [ "${{ needs.test-generated-configs.result }}" = "failure" ] || \
             [ "${{ needs.test-existing-products.result }}" = "failure" ]; then
            echo "One or more required tests failed!"
            exit 1
          fi

          echo "All tests passed!"
